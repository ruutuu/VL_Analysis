
```{r message=FALSE, warning=FALSE, include=FALSE}

library(readr)
library(readxl)
# meta-analysis packages
library(meta)
library(metafor )
#library(metagen)
library(metasens) 
# graphics packages
library(tidyverse)
library(reshape)
library(doBy)
library(stringr)
library(ggpubr)
library(patchwork)
library(dplyr)
library(data.table)

setwd("~/IDDO/Data")

#Pre-processed data (see Prepoc.R for the steps)

vl_main <- read_csv("vldata_clean_1129.csv")

#Additional variables from the study design: Relapse definitions, servere cases inclusion, tyoe if VL cases.

relapse_def <- read_excel("vl_studydesign.xlsx", 
    sheet = "outcome_defintion", col_types = c("numeric", 
        "skip", "skip", "text", "text"))

relapse_def$relapse_method<-tolower(relapse_def$relapse_method)

vl_sev <- read_excel("vl_studydesign.xlsx", 
    sheet = "disease_severity", col_types = c("skip", 
        "numeric", "skip", "numeric", "skip", 
        "text", "numeric", "skip", "text", 
        "skip", "text"))



setDT(vl_sev)[, arm_no := rowid(tag)]
vl_sev$id<-paste0(vl_sev$tag,"_",vl_sev$arm_no)
vl_sev$tag<-NULL
vl_sev$Arm_ID<-NULL

vl_sae <- read_excel("VL_SAE.xlsx", sheet = "VL_SAEs_per_arm_04_12_2019", 
col_types = c("skip", "skip", "skip", 
   "numeric", "skip", "numeric", "skip", 
       "skip", "skip", "skip", "skip", "text", 
       "skip", "skip", "numeric", "numeric", 
        "skip", "skip", "skip", "skip", "skip"))

vl_sae$id<-paste0(vl_sae$Tag,"_",vl_sae$Repeat.Instance )
vl_sae$Tag<-NULL
vl_sae$Repeat.Instance<-NULL

vl_6monthplus_relapse <- read_excel("vl_6monthplus_relapse.xlsx")
vl_6monthplus_relapse$id<-paste0(vl_6monthplus_relapse$pub_id,"_",vl_6monthplus_relapse$redcap_repeat_instance)
vl_6monthplus_relapse$pub_id<-NULL
vl_6monthplus_relapse$redcap_repeat_instance<-NULL

df<-vl_main[,c('pub_id',
               'st_intv_arms',
               'redcap_repeat_instance',
               'st_followup',
              'me_hiv_yn',
               'eff_arm_icure_num',
               'eff_arm_icure_days',
               'eff_arm_relapse_num',
               'eff_arm_relapse_days',
               'st_status',
               'st_design',
               'st_allocation',
               'st_country_num',	
               'st_country1',
               'st_region',
               'sa_num_tx'	,
               'sa_num_followup',
               'sa_combi',
               'sa_intv1_drug',
               'sa_intv1_dose_mgkg',
               'sa_intv1_freq_discrete',
              'sa_intv1_freq_new',
              'sa_int1_total_dose',
               'sa_intv1_dura',
               'sa_intv1_reg_detail' ,
               'sa_intv2_drug',
               'sa_intv2_dose_mgkg',
               'sa_intv2_freq_discrete',
               'sa_intv2_dura',
              'sa_intv2_reg_detail')]


#Unique ID for every study & arm
df$id<-paste0(df$pub_id,"_",df$redcap_repeat_instance)

df$eff_arm_icure_num<-as.numeric(df$eff_arm_icure_num)
df$eff_arm_relapse_num<-as.numeric(df$eff_arm_relapse_num)
df$sa_num_followup<-as.numeric(df$sa_num_followup)

df0<-left_join(df,vl_sev,by="id")
colnames(relapse_def)[1]<-"pub_id"
df0<-left_join(df0,relapse_def,by="pub_id")
 
df0$tag<-NULL
df0$Arm_ID<-NULL
df0$arm_no<-NULL

#Subset unpublished studies
df<-subset(df0,df0$st_status=="Published")

df<-left_join(df,vl_sae,by='id')
df<-left_join(df,vl_6monthplus_relapse ,by='id')

length(unique(df0$pub_id))
length(unique(df$pub_id))
rm(vl_sev)
rm(relapse_def)
rm(df0)
rm(vl_main)
```

PRE-PROCESSING THE FINAL DATASET FOR ANALYSIS:

I)Creating drug classes, follow up duration related variables.
II) Adding residuals to 0 event studies
III) Filtering out studies:
  1. Removing HIV co-infection based studies
  2. Missing info
  3. < 6month follow-up
  4. Unpublished (already removed)

```{r message=FALSE, warning=FALSE, include=FALSE}


#Single drug or combination therapy. mono=1 for single drug
df$mono<-ifelse(is.na(df$sa_intv2_drug),1,0 )

#Making new treatment name
df$drug<-ifelse(df$mono==1,df$sa_intv1_drug, paste0(df$sa_intv1_drug,' & ',df$sa_intv2_drug))

#Drug list
druglist<-unique(df$drug)

#Dosage of LamB?
df$sd<-ifelse(df$sa_intv1_freq_new=="Single dose",1,
              ifelse(df$sa_intv1_freq_new=="Unknown",99,0))


df$dcat<-ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==1 & df$sd==1),"LamB SD Mono", #LamB single dose Mono
         ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==0 & df$sd==1),"LamB SD Comb",#LamB single dose Combo
         ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==1 & df$sd==0),"LamB MD Mono",#LamB multi dose Mono
         ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==0 & df$sd==0),"LamB MD Comb",#LamB multi dose Combo
         ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" &  df$mono==1 & df$sd==99),"LamB UD Mono",#LamB ? dose Mono
         ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" &  df$mono==0 & df$sd==99),"LamB UD Comb",0))))))#LamB ? dose Combo


library(readxl)
drug_cat <- read_excel("DrugCategories.xlsx", sheet = "drug_category")
colnames(drug_cat)<-c("drug","drug_cat_others","Freq")
df1<-left_join(df,drug_cat,by='drug')
df1$Freq<-NULL
df1$drugcat<-ifelse(df1$dcat==0,df1$drug_cat_others,df1$dcat)


#Drug category list
drugcatlist<-unique(df1$drugcat)
length(unique(df1$pub_id))


#Subsetting studies with NA values
#Removing studies with no reported denominator/cured numbers and 0 cured ones
#Not removing those with NA as relapse num, because total_relapse maynot be NA

df2<-subset(df1,df1$eff_arm_icure_num>0)

df2$n_icured<-df2$eff_arm_icure_num
#-----------------------------------------------------------------------------------------------------------------------

length(unique(df2$pub_id))

#Remove studies with HIV co-infections
df_all<-subset(df2,!df2$me_hiv_yn=="Yes")
length(unique(df_all$pub_id))
df_hiv<-subset(df2,df2$me_hiv_yn=="Yes")
length(unique(df_hiv$pub_id))


#Remove studies with <6 month follow-up
df_all<-subset(df_all,!df_all$st_followup<180)
length(unique(df_all$pub_id))
table(df_all$eff_arm_relapse_days)

#Marking ones with 180 day follow-up: Categorizing studies by measurement of relapse time: 

#1) Studies with relapse days (reported) for exact 180--                             --1--  eff_relapse_num 
#2) Studies with relapse days (reported) of >180 and info on relapse at 6 month      --2--  relapse_6+relapse_6l
#3) Studies with relapse days (reported) of >180 and no info on relapse at 6 month   --0--  NA

#Important to treat NA and 0 differently. If NA/no info at 6 months, relapse_measurement_time (rmt) cannot be 180!
#If it is 0 at 6 months, can be included, rmt can be 180

df_all$rmt180<-ifelse(df_all$eff_arm_relapse_days==180,1,
                      ifelse(df_all$eff_arm_relapse_days>180&(!is.na(df_all$relapse_6)),2,0))


#Final relapse number variable at 180 days: frel180

df_all$frel180<-ifelse(df_all$eff_arm_relapse_days==180&is.na(df_all$relapse_6_12),df_all$eff_arm_relapse_num,
              ifelse(df_all$eff_arm_relapse_days==180&!is.na(df_all$relapse_6_12),rowSums(df_all[,c("relapse_6l","relapse_6")],na.rm=TRUE),
                                ifelse(df_all$rmt180==2,rowSums(df_all[,c("relapse_6l","relapse_6")],na.rm = TRUE),NA)))


#Some studies with relapse_time less than 180!! 


#Marking ones with 180-360 day follow-up: Categorizing studies by measurement of relapse time: 
#1) Studies with relapse days (reported) of >180 and info on relapse at 6-12 month              --1--  relapse_6-12 only!! DONT TAKE relapse_6!
#2) Studies with relapse days (reported) of >180 and no info on relapse at 6-12 month (NA)      --0--  NA


df_all$rmt360<-ifelse(df_all$eff_arm_relapse_days>=180&(!is.na(df_all$relapse_6_12)),1,0)
df_all$frel360<-ifelse(df_all$rmt360==1,df_all$relapse_6_12,NA)

#Converting to factors:
df_all$cases_grouped<-as.factor(df_all$cases_grouped)
df_all$cases_grouped[is.na(df_all$cases_grouped)]<-"Unclear"
df_all$severe_ka_included[is.na(df_all$severe_ka_included)]<-"Unclear"
df_all$relapse_method[is.na(df_all$relapse_method)]<-"Not defined"
df_all$relapse_method[df_all$relapse_method=="parasitological"]<-"Parasitological"
df_all$relapse_method<-as.factor(df_all$relapse_method)

df_all$n_relapse<-ifelse(df_all$eff_arm_relapse_num==0,0.5,df_all$eff_arm_relapse_num)
df_all$n_ifail<-df_all$sa_num_tx-df_all$n_icured

df_all[,c("number_of_deaths","n_SAEs","pkdl")]<-sapply(df_all[,c("number_of_deaths","n_SAEs","pkdl")], as.numeric)
df_all<-as.data.frame(df_all)

#Defining the composite measure:Initial Failures, Relapses and deaths!!!

df_all$compo<-rowSums(df_all[,c("eff_arm_relapse_num","number_of_deaths","n_ifail")],na.rm = TRUE)

df_main<-df_all
```

```{r}
study_count<- df_all %>%                              # Applying group_by & summarise
  group_by(st_followup) %>%
  summarise(count = n_distinct(pub_id))

```

Overall Meta-analysis : By Drug category and by Region
<br />
<br />

```{r echo=FALSE, message=FALSE, warning=FALSE}
print("Meta-analysis overall")


df_all<-subset(df_all,!df_all$n_relapse<0)
df_all<-subset(df_all,!is.na(df_all$n_icured))

m_all<- metaprop(
  data = df_all,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_all)



m_all.drugcat<-update.meta(m_all, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by drug Category")
summary(m_all.drugcat)

m_all.region<-update.meta(m_all, 
            byvar=st_region,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by Region")
summary(m_all.region)

m_all.casetype<-update.meta(m_all, 
            byvar= cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by Case type")
summary(m_all.region)



m_all.sevcases<-update.meta(m_all, 
            byvar= severe_ka_included,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by severe case inclusion")
summary(m_all.sevcases)


m_all.relapsemethod<-update.meta(m_all, 
            byvar= relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by relapse method")
summary(m_all.sevcases)

```

Focus on 13 studies with follow up duration of more than 6 months
```{r}
df_13<-subset(df_main,df_main$rmt360==1)
df_13f<-subset(df_13,!df_13$drugcat%in%c("AmphB (Unk)","Sitamaquine",  "Others"))

m13_6<- metaprop(
  data = df_13,
  event =  frel180,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE)

summary(m13_6)

events_m13_6<-df_13f %>% 
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180,na.rm = TRUE),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_m13_drug<-df_13 %>% 
  dplyr::group_by(drugcat) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180,na.rm = TRUE),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))


dt<-subset(df_13,df_13$drugcat==dc13[1])
dt<-subset(dt,!is.na(dt$frel180))
m<-metaprop(
  data = dt,
  event =  frel180,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE)

summary(m)


m13_612<- metaprop(
  data = df_13f,
  event =  frel360,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE)

summary(m13_612)

events_m13_612<-df_13f %>% 
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel360,na.rm = TRUE),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

```
TF estimation!


```{r}

```


Focus on studies with 6 month follow-up.
```{r}
#MAIN DATA SET FOR NOW!!
df_6m<-subset(df_main,df_main$rmt180>0)

df_6m<-subset(df_6m,df_6m$eff_arm_icure_num>0)

m_6m<- metaprop(
  data = df_6m,
  event =  frel180,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_6m)

events_6m<-df_6m %>% 
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

m_6m.drugcat<-update.meta(m_6m, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.drugcat)

events_drugcat<-df_6m %>% 
  dplyr::group_by(drugcat) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_drugcat

m_6m.region<-update.meta(m_6m, 
            byvar=st_region,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.region)
events_region<-df_6m %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_region

#-----------
m_6m.casetype<-update.meta(m_6m, 
            byvar=cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.casetype)

events_casetype<-df_6m %>% 
  dplyr::group_by(cases_grouped) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_casetype

m_6m.rel<-update.meta(m_6m, 
            byvar=relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.rel)

events_rel<-df_6m %>% 
  dplyr::group_by(relapse_method) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

m_6m.sevcases<-update.meta(m_6m, 
            byvar=severe_ka_included ,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.sevcases)


events_sev<-df_6m %>% 
  dplyr::group_by(severe_ka_included) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

```

```{r}
#MAIN DATA SET FOR NOW!!
df_612m<-subset(df_main,df_main$rmt360>0)

df_612m<-subset(df_612m,df_612m$eff_arm_icure_num>0)

m_612m<- metaprop(
  data = df_612m,
  event =  frel360,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_612m)

events_612m<-df_612m %>% 
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel360),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))


m_612m.drugcat<-update.meta(m_612m, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_612m.drugcat)

events_drugcat12<-df_612m %>% 
  dplyr::group_by(drugcat) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel360),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_drugcat12

m_612m.region<-update.meta(m_612m, 
            byvar=st_region,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_612m.region)

events_region12<-df_612m %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel360),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_region12

m_612m.casetype<-update.meta(m_612m, 
            byvar=cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_612m.casetype)

m_612m.rel<-update.meta(m_612m, 
            byvar=relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
print("Meta-analysis overall")

df_all<-df_main
df_all<-subset(df_all,!df_all$n_relapse<0)
df_all<-subset(df_all,!is.na(df_all$n_icured))

df_all$chkcomp<-ifelse(df_all$compo>df_all$sa_num_tx,1,0)
df_all<-subset(df_all,df_all$chkcomp==0)

m_all<- metaprop(
  data = df_all,
  event =  compo,
  n=sa_num_tx, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_all)



m_all.drugcat<-update.meta(m_all, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by drug Category")
summary(m_all.drugcat)

m_all.region<-update.meta(m_all, 
            byvar=st_region,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by Region")
summary(m_all.region)

m_all.casetype<-update.meta(m_all, 
            byvar= cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by Case type")
summary(m_all.casetype)



m_all.sevcases<-update.meta(m_all, 
            byvar= severe_ka_included,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by severe case inclusion")
summary(m_all.sevcases)




```


```{r}
df_6m$frel<-df_6m$frel180
df_6m$rmt<-180
df_612m$frel<-df_612m$frel360
df_612m$rmt<-360
df_comb<-rbind(df_6m,df_612m)
df_6m$frel<-NULL
df_612m$frel<-NULL
df_6m$rmt<-NULL
df_612m$rmt<-NULL

m_comb<- metaprop(
  data = df_comb,
  event =  frel,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_comb)

m_comb.rmt<-update.meta(m_comb, 
            byvar=rmt,
            comb.random = TRUE, 
            comb.fixed = F)
summary(m_comb.rmt)


df_comb.ea<-subset(df_comb,df_comb$st_region=="Eastern Africa")
m_comb.ea<- metaprop(
  data = df_comb.ea,
  event =  frel,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE)
  
  m_comb.ea.rmt<-update.meta(m_comb.ea, 
            byvar=rmt,
            comb.random = TRUE, 
            comb.fixed = F)

  m_comb.ea.drugcat<-update.meta(m_comb.ea, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)
  
 df_comb$chkcomp<-ifelse(df_comb$compo>df_comb$sa_num_tx,1,0)
df_comb<-subset(df_comb,df_comb$chkcomp==0)


m_comb_compo<- metaprop(
  data = df_comb,
  event =  compo,
  n=sa_num_tx, 
  sm = "PLOGIT",
  prediction=TRUE
)

summary(m_comb)

m_comb_compo.rmt<-update.meta(m_comb_compo, 
            byvar=rmt,
            comb.random = TRUE, 
            comb.fixed = F)
summary(m_comb_compo.rmt)

```

```{r}

df_comb1<-subset(df_comb,!df_comb$compo>df_comb$sa_num_tx)
df_comb1<-subset(df_comb1,df_comb1$rmt360==1)
length(unique(df_comb1$pub_id))


m<- metaprop(
  data = df_comb1,
  event = compo,
  n=sa_num_tx, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m)

m.rmt<-update.meta(m, 
            byvar=rmt,
            comb.random = TRUE, 
            comb.fixed = F)
summary(m.rmt)
```

A) INDIAN SC:

-Filter Indian SC

1)1st LoT: Single dose LAMB in Indian Subcontinent

-Filter LamB SD (Mono only)
-Estimate Relapse Prop
-Estimate Composite
-Subgroup/Estimates for Total dosage
=Estimates at 6 month and 6-12 month!

2)  Miltefosine + Paromomycin


```{r}
df_ind<-subset(df_comb,df_comb$st_region=="India Subcontinent")
df_ind$sa_int1_total_dose<-as.numeric(df_ind$sa_int1_total_dose)

df_ind_lot1<-subset(df_ind,df_ind$drugcat=="LamB SD Mono")
df_ind_lot1<-subset(df_ind_lot1,df_ind_lot1$frel180>0)

df_ind_lot1$sa_int1_total_dose<-as.numeric(df_ind_lot1$sa_int1_total_dose)
df_ind_lot1$total_dose<-ifelse(df_ind_lot1$sa_int1_total_dose<=5,"3-5",ifelse(df_ind_lot1$sa_int1_total_dose<=10,"5-10","10-15"))
table(df_ind_lot1$sa_int1_total_dose)
table(df_ind_lot1$total_dose)

m<- metaprop(
  data = df_ind_lot1,
  event = frel180,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m)
m.dose<-update.meta(m, 
            byvar=total_dose,
            comb.random = TRUE, 
            comb.fixed = F)
summary(m.dose)


m.drug<-update.meta(m, 
            byvar=drug,
            comb.random = TRUE, 
            comb.fixed = F)
summary(m.drug)




mc<- metaprop(
  data = df_ind_lot1,
  event =  compo,
  n=sa_num_tx, 
  sm = "PLOGIT",
  prediction=TRUE
)

summary(mc)


mc.dose<-update.meta(mc, 
            byvar=total_dose,
            comb.random = TRUE, 
            comb.fixed = F)
summary(mc.dose)




df_ind_lot<-subset(df_ind,df_ind$drugcat %in% c("LamB SD Mono","LamB SD Comb"))
df_ind_lot<-subset(df_ind_lot,df_ind_lot$frel180>0)
df_ind_lot$sa_int1_total_dose<-as.numeric(df_ind_lot$sa_int1_total_dose)
df_ind_lot$total_dose<-ifelse(df_ind_lot$sa_int1_total_dose<=5,"3-5",ifelse(df_ind_lot$sa_int1_total_dose<=10,"5-10","10-15"))

m<- metaprop(
  data = df_ind_lot,
  event = frel180,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m)
m.dose<-update.meta(m, 
            byvar=total_dose,
            comb.random = TRUE, 
            comb.fixed = F)
summary(m.dose)


mc<- metaprop(
  data = df_ind_lot,
  event =  compo,
  n=sa_num_tx, 
  sm = "PLOGIT",
  prediction=TRUE
)

summary(mc)


mc.dose<-update.meta(mc, 
            byvar=total_dose,
            comb.random = TRUE, 
            comb.fixed = F)
summary(mc.dose)

```



B) EAST AFRICA

1) 1st LoT

2) 2nd LoT


```{r}

```

Stratified analysis by Drug categories
For studies with 6 month follow-up!

```{r echo=TRUE, message=FALSE, warning=FALSE}
final<-NULL
for (i in 1:18){
  1
tmp<- df_6m[which(df_6m$drugcat==drugcatlist[i]),]

if(nrow(tmp)==0) next
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event = frel180,#Relapse variable to be considered: Here it is at 180 days
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_region<-update.meta(m, 
            byvar=st_region, 
            comb.random = TRUE, 
            comb.fixed = F)
assign(paste0("m_region_",i),m_region)

s<-summary(m_region)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
region<-s$bylevs
dm<-cbind(region,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)
dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel180), #Relapse variable to be considered: Here it is at 180 days
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"region"


dm<-left_join(dm,events_region,by='region')

final<-rbind(final,dm)
assign(paste0("dm_",i),dm)
 
print(drugcatlist[i])
print(s)
}

final_store<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "region",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Region","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_region_6m_1130.csv")#Change date and name
```

Stratified analysis by Drug categories
For studies with 6 month++ follow-up!

```{r echo=TRUE, message=FALSE, warning=FALSE}
final<-NULL
df_6mplus<-df_612m

  for (i in c(1:5,7:10,12:18)){
  
tmp<- df_6mplus[which(df_6mplus$drugcat==drugcatlist[i]),]
if(nrow(tmp)==0) next
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  frel360,  #Relapse variable to be considered: Here it is at 360 days
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_region<-update.meta(m, 
            byvar=st_region, 
            comb.random = TRUE, 
            comb.fixed = F)
assign(paste0("m_region_",i),m_region)

s<-summary(m_region)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
region<-s$bylevs
dm<-cbind(region,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)
dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(frel360), #Relapse variable to be considered: Here it is at 180 days
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"region"


dm<-left_join(dm,events_region,by='region')

final<-rbind(final,dm)
assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)
}
```


```{r echo=TRUE, message=FALSE, warning=FALSE}


final_store_6mplus<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "region",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Region","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_region_6mplus_1130.csv")
```

Estimates for Composite measure!
1. Overall
2. At 6 months
3. At 6-12 months
4. At 6 months: By drug? BY Region?



```{r}

```

```{r}
final<-NULL

for (i in c(1:18)){
  
tmp<- df_all[which(df_all$drugcat==drugcatlist[i]),]
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
#assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_fud<-update.meta(m, 
            byvar=fud, 
            comb.random = TRUE, 
            comb.fixed = F)

s<-summary(m_fud)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
fud<-s$bylevs
dm<-cbind(fud,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)
dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(fud) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"fud"


dm<-left_join(dm,events_region,by='fud')

final<-rbind(final,dm)
}
#assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)

```

```{r}
final_store_allbyfud<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "fud",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Follow-up Duration","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_region_byFUD.csv")
```

Exploring some drugs by different duration: Lam SD mono and combo: Checking for stat sig diff in fud

```{r}
df_3<-subset(df_all,df_all$drugcat==drugcatlist[3])

m_3<- metaprop(
  data = df_3,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_3)


m_3.fud<-update.meta(m_3, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_3.fud180<-update.meta(m_3, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)



df_10<-subset(df_all,df_all$drugcat==drugcatlist[10])

m_10<- metaprop(
  data = df_10,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_10)


m_10.fud<-update.meta(m_10, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_10.fud180<-update.meta(m_10, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)


m_10.fud
m_10.fud180




df_2<-subset(df_all,df_all$drugcat==drugcatlist[2])

m_2<- metaprop(
  data = df_2,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_2)


m_2.fud<-update.meta(m_2, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_2.fud180<-update.meta(m_2, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)


m_2.fud
m_2.fud180



df_11<-subset(df_all,df_all$drugcat==drugcatlist[11])

m_11<- metaprop(
  data = df_11,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_11)


m_11.fud<-update.meta(m_11, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_11.fud180<-update.meta(m_11, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)


m_11.fud
m_11.fud180



```

```{r}
final<-NULL

for (i in c(1:17)){
  
tmp<- df_6m[which(df_6m$drugcat==drugcatlist[i]),]
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
#assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_fud<-update.meta(m, 
            byvar=cases_grouped, 
            comb.random = TRUE, 
            comb.fixed = F)

s<-summary(m_fud)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
#Change variable here#############
cg<-s$bylevs
dm<-cbind(cg,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)


dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(cases_grouped) %>% ####Change variable here: 
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"cg" #####Change variable here


dm<-left_join(dm,events_region,by='cg') ####Change variable here

final<-rbind(final,dm)
}
#assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)

```

```{r}
final_store_allbycg6m<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "cg",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Case type","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_6m_byCaseType.csv")
```