
```{r message=FALSE, warning=FALSE, include=FALSE}

library(readr)
library(readxl)
# meta-analysis packages
library(meta)
library(metafor )
#library(metagen)
library(metasens) 
# graphics packages
library(tidyverse)
library(reshape)
library(doBy)
library(stringr)
library(ggpubr)
library(patchwork)
library(dplyr)
library(data.table)

setwd("~/IDDO/Data")

#Pre-processed data (see Prepoc.R for the steps)

vl_main <- read_csv("vldata_clean.csv")

#Additional variables from the study design: Relapse deifinitions, servere cases inclusion, tyoe if VL cases.

relapse_def <- read_excel("vl_studydesign.xlsx", 
    sheet = "outcome_defintion", col_types = c("numeric", 
        "skip", "skip", "text", "text"))

vl_sev <- read_excel("vl_studydesign.xlsx", 
    sheet = "disease_severity", col_types = c("skip", 
        "numeric", "skip", "numeric", "skip", 
        "text", "numeric", "skip", "text", 
        "skip", "text"))

setDT(vl_sev)[, arm_no := rowid(tag)]
vl_sev$id<-paste0(vl_sev$tag,"_",vl_sev$arm_no)


df<-vl_main[,c('pub_id',
               'st_intv_arms',
               'redcap_repeat_instance',
               'st_followup',
              'me_hiv_yn',
               'eff_arm_icure_num',
               'eff_arm_icure_days',
               'eff_arm_relapse_num',
               'eff_arm_relapse_days',
               'st_status',
               'st_design',
               'st_allocation',
               'st_country_num',	
               'st_country1',
               'st_region',
               'sa_num_tx'	,
               'sa_num_followup',
               'sa_combi',
               'sa_intv1_drug',
               'sa_intv1_dose_mgkg',
               'sa_intv1_freq_discrete',
               'sa_intv1_dura',
               'sa_intv2_drug',
               'sa_intv2_dose_mgkg',
               'sa_intv2_freq_discrete',
               'sa_intv2_dura')]


#Unique ID for every study & arm
df$id<-paste0(df$pub_id,"_",df$redcap_repeat_instance)
df$eff_arm_icure_num<-as.numeric(df$eff_arm_icure_num)
df$eff_arm_relapse_num<-as.numeric(df$eff_arm_relapse_num)
df$sa_num_followup<-as.numeric(df$sa_num_followup)

df0<-left_join(df,vl_sev,by="id")
colnames(relapse_def)[1]<-"pub_id"
df0<-left_join(df0,relapse_def,by="pub_id")
df0$tag<-NULL
df0$Arm_ID<-NULL
df0$arm_no<-NULL

#Subset unpublished studies
df<-subset(df0,df0$st_status=="Published")
length(unique(df0$pub_id))
length(unique(df$pub_id))
rm(vl_sev)
rm(relapse_def)
```

Creating drug classes, follow up duration related variables.

```{r message=FALSE, warning=FALSE, include=FALSE}
#Single drug or combinational therapy. mono=1 for single drug
df$mono<-ifelse(is.na(df$sa_intv2_drug),1,0 )

#MAking new treatment name
df$drug<-ifelse(df$mono==1,df$sa_intv1_drug,
                paste0(df$sa_intv1_drug,' & ',df$sa_intv2_drug))

#Drug list
druglist<-unique(df$drug)

#Dosage of LamB?
df$sd<-ifelse(df$sa_intv1_freq_discrete=="Single dose",1,
              ifelse(is.element(df$sa_intv1_freq_discrete,c("Other","Unknown")),99,0))


df$dcat<-ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==1 & df$sd==1),"LamB SD Mono", #LamB single dose Mono
        ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==0 & df$sd==1),"LamB SD Comb",#LamB single dose Combo
        ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==1 & df$sd==0),"LamB MD Mono",#LamB multi dose Mono
        ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" & df$mono==0 & df$sd==0),"LamB MD Comb",#LamB multi dose Combo
        ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" &  df$mono==1 & df$sd==99),"LamB UD Mono",#LamB ? dose Mono
        ifelse((df$sa_intv1_drug=="Liposomal Amphotericin B (L-AmB)" &  df$mono==0 & df$sd==99),"LamB MD Comb",0))))))#LamB ? dose Combo


library(readxl)
drug_cat <- read_excel("DrugCategories.xlsx", sheet = "drug_category")
colnames(drug_cat)<-c("drug","drug_cat_others","Freq")
df1<-left_join(df,drug_cat,by='drug')
df1$Freq<-NULL
df1$drugcat<-ifelse(df1$dcat==0,df1$drug_cat_others,df1$dcat)

#Variable for defining follow-up wrt 6 month mark
df1$fud180<-ifelse(df1$st_followup==180,1,ifelse(df1$st_followup>180,2,0))

#Variable to categorize follow-up duration
df1$fud<-ifelse(df1$st_followup==180,"6",ifelse(df1$st_followup>=360,"12","6-12"))

#Drug category list
drugcatlist<-unique(df1$drugcat)
```

Adding residuals to 0 event studies
Filtering out studies:
  1. Removing HIV co-infection based studies
  2. Missing info
  3. < 6month follow-up
  4. Unpublished (already removed)
```{r message=FALSE, warning=FALSE, include=FALSE}

length(unique(df1$pub_id))

df1$n_relapse<-ifelse(df1$eff_arm_relapse_num==0,0.5,df1$eff_arm_relapse_num)

#Subsetting studies with NA values
df2<-subset(df1,!is.na(df1$eff_arm_relapse_num))
df2<-subset(df2,df2$n_relapse>0)
df2<-subset(df2,!is.na(df2$eff_arm_icure_num))
df2$n_icured<-df2$eff_arm_icure_num
df2<-subset(df2,df2$n_icured>0)


length(unique(df2$pub_id))

#Remove studies with HIV co-infections
df_all<-subset(df2,!df2$me_hiv_yn=="Yes")
length(unique(df_all$pub_id))

#Remove studies with <6 month follow-up
df_all<-subset(df_all,!df_all$fud180==0)

length(unique(df_all$pub_id))
df_hiv<-subset(df2,df2$me_hiv_yn=="Yes")
length(unique(df_hiv$pub_id))

#Converting to factors:
df_all$cases_grouped<-as.factor(df_all$cases_grouped)
df_all$cases_grouped[is.na(df_all$cases_grouped)]<-"Unclear"
df_all$severe_ka_included[is.na(df_all$severe_ka_included)]<-"Unclear"
df_all$relapse_method[is.na(df_all$relapse_method)]<-"Not defined"
df_all$relapse_method<-as.factor(df_all$relapse_method)
```

```{r}
study_count<- df_all %>%                              # Applying group_by & summarise
  group_by(st_followup) %>%
  summarise(count = n_distinct(pub_id))

```

Overall Meta-analysis : By Drug category and by Region
<br />

```{r echo=FALSE, message=FALSE, warning=FALSE}
print("Meta-analysis overall")

m_all<- metaprop(
  data = df_all,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_all)

m_all.fud<-update.meta(m_all, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_all.fud)

events_fud<-df_all %>% 
  dplyr::group_by(fud) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

m_all.fud180<-update.meta(m_all, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_all.fud180)

events_fud<-df_all %>% 
  dplyr::group_by(fud180) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))


m_all.drugcat<-update.meta(m_all, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by drug Category")
summary(m_all.drugcat)

m_all.region<-update.meta(m_all, 
            byvar=st_region,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by Region")
summary(m_all.region)

m_all.casetype<-update.meta(m_all, 
            byvar= cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by Case type")
summary(m_all.region)



m_all.sevcases<-update.meta(m_all, 
            byvar= severe_ka_included,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by severe case inclusion")
summary(m_all.sevcases)


m_all.relapsemethod<-update.meta(m_all, 
            byvar= relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)

print("Meta-analysis by relapse method")
summary(m_all.sevcases)

```

Focus on studies with 6 month follow-up.

```{r}
#MAIN DATA SET FOR NOW!!
df_6m<-subset(df_all,df_all$fud180==1)

m_6m<- metaprop(
  data = df_6m,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_6m)


m_6m.drugcat<-update.meta(m_6m, 
            byvar=drugcat,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.drugcat)

events_drugcat<-df_6m %>% 
  dplyr::group_by(drugcat) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_drugcat

m_6m.region<-update.meta(m_6m, 
            byvar=st_region,
            comb.random = TRUE, 
            comb.fixed = F)

events_region<-df_6m %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))

events_region

#-----------
m_6m.casetype<-update.meta(m_6m, 
            byvar=cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.casetype)

m_6m.rel<-update.meta(m_6m, 
            byvar=relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.rel)

m_6m.sevcases<-update.meta(m_6m, 
            byvar=severe_ka_included ,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m.sevcases)




```


Stratified analysis by Drug categories
For studies with 6 month follow-up!

```{r echo=TRUE, message=FALSE, warning=FALSE}
final<-NULL
for (i in 1:17){
  
tmp<- df_6m[which(df_6m$drugcat==drugcatlist[i]),]
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_region<-update.meta(m, 
            byvar=st_region, 
            comb.random = TRUE, 
            comb.fixed = F)
assign(paste0("m_region_",i),m_region)

s<-summary(m_region)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
region<-s$bylevs
dm<-cbind(region,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)
dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"region"


dm<-left_join(dm,events_region,by='region')

final<-rbind(final,dm)
assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)
}

final_store<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "region",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Region","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_region_6m.csv")
```


Exploring some drug classes in detail for 6 month follow-up studies

```{r}
df_6m_paro<-subset(df_6m,df_6m$drugcat=="Paromomycin")

m_6m_paro<- metaprop(
  data = df_6m_paro,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_6m_paro)


m_6m_paro.casetype<-update.meta(m_6m_paro, 
            byvar=cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)



m_6m_paro.rel<-update.meta(m_6m_paro, 
            byvar=relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)



m_6m_paro.sevcases<-update.meta(m_6m_paro, 
            byvar=severe_ka_included ,
            comb.random = TRUE, 
            comb.fixed = F)

summary(m_6m_paro.casetype)
summary(m_6m_paro.rel)
summary(m_6m_paro.sevcases)



```

Stratified analysis by Drug categories
For studies with 6 month++ follow-up!

```{r echo=TRUE, message=FALSE, warning=FALSE}
final<-NULL
df_6mplus<-subset(df_all,df_all$fud180==2)

  for (i in c(1:11,13)){
  
tmp<- df_6mplus[which(df_6mplus$drugcat==drugcatlist[i]),]
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_region<-update.meta(m, 
            byvar=st_region, 
            comb.random = TRUE, 
            comb.fixed = F)
assign(paste0("m_region_",i),m_region)

s<-summary(m_region)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
region<-s$bylevs
dm<-cbind(region,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)
dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(st_region) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"region"


dm<-left_join(dm,events_region,by='region')

final<-rbind(final,dm)
assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
}

final_store_6mplus<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "region",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Region","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_region_6mplus.csv")
```

Exploring cases
1. AmphB Deoxycholate

```{r}
df_6mplus_4<-subset(df_6mplus,df_6mplus$drugcat==drugcatlist[4])

m_6mplus_4<- metaprop(
  data = df_6mplus_4,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_6mplus_4)


m_6mplus_4.casetype<-update.meta(m_6mplus_4, 
            byvar=cases_grouped,
            comb.random = TRUE, 
            comb.fixed = F)



m_6mplus_4.rel<-update.meta(m_6mplus_4, 
            byvar=relapse_method,
            comb.random = TRUE, 
            comb.fixed = F)

df

m_6mplus_4.sevcases<-update.meta(m_6mplus_4, 
            byvar=severe_ka_included ,
            comb.random = TRUE, 
            comb.fixed = F)



summary(m_6mplus_4.casetype)
summary(m_6mplus_4.rel)
summary(m_6mplus_4.sevcases)

```


```{r}
final<-NULL

for (i in c(1:18)){
  
tmp<- df_all[which(df_all$drugcat==drugcatlist[i]),]
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
#assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_fud<-update.meta(m, 
            byvar=fud, 
            comb.random = TRUE, 
            comb.fixed = F)

s<-summary(m_fud)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
fud<-s$bylevs
dm<-cbind(fud,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)
dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(fud) %>%
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"fud"


dm<-left_join(dm,events_region,by='fud')

final<-rbind(final,dm)
}
#assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)

```

```{r}
final_store_allbyfud<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "fud",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Follow-up Duration","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_region_byFUD.csv")
```

Exploring some drugs by different duration: Lam SD mono and combo: Checking for stat sig diff in fud

```{r}
df_3<-subset(df_all,df_all$drugcat==drugcatlist[3])

m_3<- metaprop(
  data = df_3,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_3)


m_3.fud<-update.meta(m_3, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_3.fud180<-update.meta(m_3, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)



df_10<-subset(df_all,df_all$drugcat==drugcatlist[10])

m_10<- metaprop(
  data = df_10,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_10)


m_10.fud<-update.meta(m_10, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_10.fud180<-update.meta(m_10, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)


m_10.fud
m_10.fud180




df_2<-subset(df_all,df_all$drugcat==drugcatlist[2])

m_2<- metaprop(
  data = df_2,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_2)


m_2.fud<-update.meta(m_2, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_2.fud180<-update.meta(m_2, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)


m_2.fud
m_2.fud180



df_11<-subset(df_all,df_all$drugcat==drugcatlist[11])

m_11<- metaprop(
  data = df_11,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
summary(m_11)


m_11.fud<-update.meta(m_11, 
            byvar=fud,
            comb.random = TRUE, 
            comb.fixed = F)

m_11.fud180<-update.meta(m_11, 
            byvar=fud180,
            comb.random = TRUE, 
            comb.fixed = F)


m_11.fud
m_11.fud180



```

```{r}
final<-NULL

for (i in c(1:17)){
  
tmp<- df_6m[which(df_6m$drugcat==drugcatlist[i]),]
tmp<- droplevels(tmp)

m<- metaprop(
  data = tmp,
  event =  n_relapse,
  n=n_icured, 
  sm = "PLOGIT",
  prediction=TRUE
)
#assign(paste0("m_",i),m)


# Egger's test for assessing publication bias
#metabias(m)
#trimfill(m)

#--------------------------------
# Subgroup analysis by Drug category
#--------------------------------
m_fud<-update.meta(m, 
            byvar=cases_grouped, 
            comb.random = TRUE, 
            comb.fixed = F)

s<-summary(m_fud)
s1<-s$within.random

est<- exp(s1$TE)/(1+exp(s1$TE))
est<-round(est,4)
lb<-exp(s1$lower )/(1+exp(s1$lower))
lb<-round(lb,3)
ub<-exp(s1$upper )/(1+exp(s1$upper))
ub<-round(ub,3)

i2<-s$I2.w
i2_est<- i2$TE
i2_lb<-i2$lower
i2_ub<-i2$upper
i2_est<-round(i2_est,3)
i2_lb<-round(i2_lb,3)
i2_ub<-round(i2_ub,3)

a<-NULL
a=s$within.predict$lower
p_lb<-exp(a)/(1+exp(a))

a<-NULL
a=s$within.predict$upper
p_ub<-exp(a)/(1+exp(a))

n<-s$k.w
#Change variable here#############
cg<-s$bylevs
dm<-cbind(cg,n,est,lb,ub,i2_est,i2_lb,i2_ub,p_lb,p_ub)


dm<-as.data.frame(dm)
dm$drugcat<-drugcatlist[i]
dm<-dm[,c(11,1:10)]

o<-s$random
o_n<-s$k
o_est<-exp(o$TE)/(1+exp(o$TE))
o_lb<-exp(o$lower)/(1+exp(o$lower))
o_ub<-exp(o$upper)/(1+exp(o$upper))


oi2<-s$I2
a<-NULL
a=s$predict$lower
o_plb<-exp(a)/(1+exp(a))
a<-NULL
a=s$predict$upper
o_pub<-exp(a)/(1+exp(a))


o_row<-round(c(o_est,o_lb,o_ub,oi2$TE,oi2$lower,oi2$upper,o_plb,o_pub),3)
o_row<-c(drugcatlist[i],"Overall",o_n, o_row)


dm<-rbind(o_row,dm)


events_region<-tmp %>% 
  dplyr::group_by(cases_grouped) %>% ####Change variable here: 
  dplyr::summarise(
    n_studies 	= length(unique(pub_id)),
    n_event	= sum(n_relapse),
    n_cured	= sum(n_icured),
    n_totfu= sum(sa_num_tx))
colnames(events_region)[1]<-"cg" #####Change variable here


dm<-left_join(dm,events_region,by='cg') ####Change variable here

final<-rbind(final,dm)
}
#assign(paste0("dm_",i),dm)

print(drugcatlist[i])
print(s)

```

```{r}
final_store_allbycg6m<-final
drugcat_names <- read_excel("DrugCategories.xlsx", 
    sheet = "drug cat full names")

final<-left_join(final,drugcat_names,by="drugcat")

final<-final[,c("Drug Category", "cg",  "n_studies","n","n_cured","n_event","est", "lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")]



colnames(final)<-c("Drug Category","Case type","k","Arms","In. cured", "Relapses", "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")


cols.num <- c( "Est","lb","ub","i2_est","i2_lb","i2_ub","p_lb","p_ub")
final[cols.num] <- sapply(final[cols.num],as.numeric)
final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) x * 100)

final[, cols.num] <- lapply(final[, cols.num, drop = FALSE],
                             function(x) round(x,2))
write.csv(final,"MA_drugcat_6m_byCaseType.csv")
```